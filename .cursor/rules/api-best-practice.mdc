---
alwaysApply: true
---

# API Best Practices - NestJS ChatBot Banking System

CÃ¡c quy táº¯c báº¯t buá»™c pháº£i tuÃ¢n theo khi viáº¿t cÃ¡c API:

- Kiá»ƒu dá»¯ liá»‡u ngÃ y thÃ¡ng trong data body vÃ  data response luÃ´n á»Ÿ dáº¡ng string, format ISO 8601. TrÆ°á»›c khi tráº£ vá» response hoáº·c sau khi nháº­n tá»« body request cáº§n parse string nÃ y vá» dáº¡ng Date Ä‘á»ƒ phÃ¹ há»£p vá»›i MySql database cá»§a há»‡ thá»‘ng
- CÃ¡c kiá»ƒu dá»¯ liá»‡u lÃ  enum nháº­n tá»« data body request luÃ´n pháº£i Ä‘Æ°á»£c validate náº±m trong cÃ¡c giÃ¡ trá»‹ há»£p lá»‡ (dá»±a theo mÃ´ táº£ project hoáº·c dá»±a theo dá»¯ liá»‡u trong báº£ng tÆ°Æ¡ng á»©ng).
- Param cá»§a API luÃ´n pháº£i Ä‘Æ°á»£c validate, náº¿u lÃ  dáº¡ng id pháº£i validate id nÃ y tá»“n táº¡i
- API luÃ´n pháº£i validate dá»¯ liá»‡u Ä‘áº§u vÃ o cho tá»«ng trÆ°á»ng, luÃ´n Ä‘áº·t ra káº¿ hoáº¡ch validate sau Ä‘Ã³ triá»ƒn khai.
- CÃ¡c API pháº£i tráº£ vá» html status code trÃ¹ng vá»›i trÆ°á»ng statusCode trong response (sá»­ dá»¥ng exception Ä‘á»ƒ xá»­ lÃ½ cÃ¡c trÆ°á»ng há»£p lá»—i thay vÃ¬ return response)
- Sá»­ dá»¥ng hÃ m formatDateToISO Ä‘á»ƒ format sang dáº¡ng string ISO 8601, formatDateOnly Ä‘á»ƒ format sang dáº¡ng string YYYY-MM-DD
- Kiá»ƒu dá»¯ liá»‡u ngÃ y thÃ¡ng (date, datetime) luÃ´n lÃ  dáº¡ng string ISO 8601 á»Ÿ trong body vÃ  response, luÃ´n pháº£i Ä‘Æ°á»£c parse vá» dáº¡ng Date object trÆ°á»›c khi tráº£ vá» response hoáº·c lÆ°u vÃ o database.
- Trong cÃ¡c trÆ°á»ng há»£p API lÃ  update thÃ´ng tin, náº¿u chá»‰ cÃ³ má»™t sá»‘ trÆ°á»ng cÃ³ data trong body request thÃ¬ cÃ¡c trÆ°á»ng cÃ²n láº¡i pháº£i giá»¯ nguyÃªn giÃ¡ trá»‹ hiá»‡n táº¡i cá»§a chÃºng.

## ğŸ“‹ QUY Táº®C VIáº¾T API

### ğŸ” 1. Authentication & Authorization

```typescript
// LuÃ´n thÃªm @ApiBearerAuth() cho cÃ¡c API cáº§n JWT
@ApiBearerAuth()
@UseGuards(JwtAuthenticationGuard)

// ThÃªm PermissionsGuard náº¿u cáº§n phÃ¢n quyá»n.
Tuá»³ phÃ¢n quyá»n sáº½ sá»­ dá»¥ng cÃ¡c PermissionName khÃ¡c nhau.
@UseGuards(JwtAuthenticationGuard, PermissionsGuard)'

//Example permission name "permission"
@Permissions(PermissionName.PERMISSION)
```

### ğŸ“ 2. Swagger Documentation

```typescript
// LuÃ´n cÃ³ @ApiOperation vÃ  @ApiResponse
@ApiOperation({ summary: 'MÃ´ táº£ ngáº¯n gá»n API' })
@ApiResponse({
  status: 200,
  description: 'MÃ´ táº£ response thÃ nh cÃ´ng',
  schema: { /* Chi tiáº¿t schema */ }
})
@ApiResponse({
  status: 401,
  description: 'Unauthorized', // Cho API cÃ³ JWT
})
```

### ğŸ¯ 3. Response Format Chuáº©n

```typescript
// Return type luÃ´n lÃ  BaseResponse
async methodName(): Promise<BaseResponse> { }
```

### ğŸ—“ï¸ 4. Xá»­ LÃ½ Date/Time

```typescript
// Request Body: LuÃ´n nháº­n string ISO 8601
@IsDateString()
@IsOptional()
dateOfBirth?: string;

// Chuyá»ƒn Ä‘á»•i trong Controller trÆ°á»›c khi gá»i Service
const updateData: Partial<User> = {
  ...body,
  dateOfBirth: body.dateOfBirth ? new Date(body.dateOfBirth) : undefined,
};

// Response: LuÃ´n format thÃ nh string
dateOfBirth: formatDateOnly(user.dateOfBirth),        // YYYY-MM-DD
lastLoginAt: formatDateToISO(user.lastLoginAt),       // ISO DateTime
```

### âš ï¸ 5. Error Handling

```typescript
// LuÃ´n throw HttpException thay vÃ¬ return error object
throw new HttpException('ThÃ´ng bÃ¡o lá»—i', HttpStatus.BAD_REQUEST);

// Catch vÃ  re-throw HttpException trong controller
try {
  // logic
} catch (error) {
  if (error instanceof HttpException) {
    throw error;
  }
  throw new HttpException('Lá»—i server', HttpStatus.INTERNAL_SERVER_ERROR);
}
```

### âœ… 6. Validation

```typescript
// LuÃ´n sá»­ dá»¥ng class-validator cho DTO
@IsString()
@IsNotEmpty()
username: string;

@IsEmail()
@IsOptional()
email?: string;

@IsDateString()
@IsOptional()
dateOfBirth?: string;
```

### ğŸ—ï¸ 7. HTTP Status Codes

```typescript
// Äáº£m báº£o HTTP status code khá»›p vá»›i response statusCode
@HttpCode(200)  // GET, PUT thÃ nh cÃ´ng
@HttpCode(201)  // POST táº¡o má»›i thÃ nh cÃ´ng
@HttpCode(204)  // DELETE thÃ nh cÃ´ng (no content)
```

---

## ğŸ› ï¸ HÃ€M CHUNG CHO CÃC API

### ğŸ“… Date Utilities (`src/utils/date-formatter.ts`)

```typescript
// Format date an toÃ n tá»« MySQL
formatDateToISO(date: Date | string | null | undefined): string | null
formatDateOnly(date: Date | string | null | undefined): string | null

// Sá»­ dá»¥ng:
dateOfBirth: formatDateOnly(user.dateOfBirth),
lastLoginAt: formatDateToISO(user.lastLoginAt),
```

### ğŸ”„ Date Transformer (`src/utils/date-transformer.ts`)

```typescript
// Äáº£m báº£o MySQL date/datetime luÃ´n thÃ nh Date object
export const DateTransformer: ValueTransformer

// Ãp dá»¥ng trong Entity:
@Column({
  type: 'date',
  transformer: DateTransformer,
})
public dateOfBirth?: Date;
```

### ğŸ“¤ Response Helper (`src/types/http-response.ts`)

```typescript
// Response chuáº©n cho táº¥t cáº£ API
HttpResponse.success(data, message);
HttpResponse.created(data, message);
HttpResponse.error(message, statusCode);

// Base response interface
interface BaseResponse<T = any> {
  statusCode: number;
  message: string;
  data?: T;
}
```

### ğŸ” JWT Utilities

```typescript
// Guard cho authentication
JwtAuthenticationGuard

// Guard cho authorization
PermissionsGuard

// Decorator cho permissions
@Permissions(PermissionName.PERMISSION)

// Interface cho request vá»›i user
RequestWithUser
```

---

## ğŸ“ STRUCTURE CHUáº¨N CHO Má»˜T API MODULE

```
src/modules/[module-name]/
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ create-[entity].dto.ts
â”‚   â”œâ”€â”€ update-[entity].dto.ts
â”‚   â””â”€â”€ [specific-action].dto.ts
â”œâ”€â”€ entities/
â”‚   â”œâ”€â”€ [entity].entity.ts
â”‚   â””â”€â”€ [related-entities].entity.ts
â”œâ”€â”€ types/
â”‚   â””â”€â”€ [custom-types].ts
â”œâ”€â”€ [module].controller.ts
â”œâ”€â”€ [module].service.ts
â””â”€â”€ [module].module.ts
```

---

## ğŸ¯ CHECKLIST CHO Má»–I API

- [ ] âœ… **Swagger**: `@ApiOperation`, `@ApiResponse`, `@ApiBearerAuth`
- [ ] ğŸ” **Auth**: `@UseGuards(JwtAuthenticationGuard)` náº¿u cáº§n
- [ ] ğŸ« **Permission**: `@Permissions()` náº¿u cáº§n phÃ¢n quyá»n
- [ ] ğŸ“ **DTO**: Validation vá»›i `class-validator`
- [ ] ğŸ“ **Param**: Validate param cá»§a API
- [ ] ğŸ“ **Body**: Validate body cá»§a API
- [ ] ğŸ—“ï¸ **Date**: Sá»­ dá»¥ng `formatDateToISO()`, `formatDateOnly()`
- [ ] ğŸ“¤ **Response**: Return `BaseResponse` vá»›i `HttpResponse` helper
- [ ] âš ï¸ **Error**: Throw `HttpException` vá»›i status code Ä‘Ãºng
- [ ] ğŸ”¢ **HTTP Code**: `@HttpCode()` khá»›p vá»›i response statusCode
- [ ] ğŸ“Š **Logging**: Log error vá»›i `this.logger.error()`

---

## ğŸŒŸ BEST PRACTICES

1. **Consistency**: Táº¥t cáº£ API cÃ³ cÃ¹ng format response
2. **Type Safety**: Sá»­ dá»¥ng TypeScript interfaces vÃ  DTOs
3. **Validation**: Validate input á»Ÿ Controller level
4. **Error Handling**: Centralized error handling vá»›i HttpException
5. **Date Handling**: Consistent ISO format cho client-server communication
6. **Documentation**: Complete Swagger documentation cho má»i API
7. **Security**: JWT protection vÃ  permission-based access control

---

## ğŸ“– VÃ Dá»¤ TEMPLATE API HOÃ€N CHá»ˆNH

### Controller Example

```typescript
import {
  Body,
  Controller,
  Get,
  Post,
  Put,
  UseGuards,
  Req,
  Param,
  HttpCode,
  HttpException,
  HttpStatus,
} from '@nestjs/common';
import {
  ApiTags,
  ApiOperation,
  ApiResponse,
  ApiBearerAuth,
} from '@nestjs/swagger';
import { HttpResponse, BaseResponse } from '../../types/http-response';
import { formatDateToISO, formatDateOnly } from '../../utils/date-formatter';
import JwtAuthenticationGuard from '../auth/jwt-authentication.guard';
import { PermissionsGuard } from '../auth/guards/permissions.guard';
import { Permissions } from '../auth/decorators/permissions.decorator';
import RequestWithUser from '../auth/intefaces/requestWithUser.interface';

@ApiTags('Example')
@Controller('example')
export class ExampleController {
  constructor(private readonly exampleService: ExampleService) {}

  @ApiOperation({ summary: 'Táº¡o entity má»›i' })
  @ApiResponse({
    status: 201,
    description: 'Táº¡o thÃ nh cÃ´ng',
  })
  @ApiResponse({
    status: 401,
    description: 'Unauthorized',
  })
  @ApiBearerAuth()
  @UseGuards(JwtAuthenticationGuard, PermissionsGuard)
  @Permissions(PermissionName.PERMISSION)
  @Post('create')
  @HttpCode(201)
  async create(
    @Body() createDto: CreateExampleDto,
    @Req() request: RequestWithUser,
  ): Promise<BaseResponse> {
    try {
      // Convert date string to Date object
      const entityData = {
        ...createDto,
        dateField: createDto.dateField
          ? new Date(createDto.dateField)
          : undefined,
      };

      const result = await this.exampleService.create(
        entityData,
        request.user.id,
      );

      return HttpResponse.created(result, 'Táº¡o thÃ nh cÃ´ng');
    } catch (error) {
      if (error instanceof HttpException) {
        throw error;
      }
      throw new HttpException('Táº¡o tháº¥t báº¡i', HttpStatus.INTERNAL_SERVER_ERROR);
    }
  }

  @ApiOperation({ summary: 'Láº¥y thÃ´ng tin entity' })
  @ApiResponse({
    status: 200,
    description: 'Láº¥y thÃ´ng tin thÃ nh cÃ´ng',
  })
  @ApiResponse({
    status: 401,
    description: 'Unauthorized',
  })
  @ApiBearerAuth()
  @UseGuards(JwtAuthenticationGuard)
  @Get(':id')
  async getById(@Param('id') id: string): Promise<BaseResponse> {
    try {
      const entity = await this.exampleService.findById(id);

      // Format dates for response
      const formattedEntity = {
        ...entity,
        dateField: formatDateOnly(entity.dateField),
        createdAt: formatDateToISO(entity.createdAt),
        updatedAt: formatDateToISO(entity.updatedAt),
      };

      return HttpResponse.success(formattedEntity, 'Láº¥y thÃ´ng tin thÃ nh cÃ´ng');
    } catch (error) {
      if (error instanceof HttpException) {
        throw error;
      }
      throw new HttpException(
        'Láº¥y thÃ´ng tin tháº¥t báº¡i',
        HttpStatus.INTERNAL_SERVER_ERROR,
      );
    }
  }
}
```

### DTO Example

```typescript
import { ApiProperty } from '@nestjs/swagger';
import {
  IsString,
  IsNotEmpty,
  IsOptional,
  IsDateString,
} from 'class-validator';

export class CreateExampleDto {
  @ApiProperty({
    description: 'TÃªn',
    example: 'TÃªn vÃ­ dá»¥',
  })
  @IsString()
  @IsNotEmpty()
  name: string;

  @ApiProperty({
    description: 'NgÃ y',
    example: '2023-12-25',
    required: false,
  })
  @IsDateString()
  @IsOptional()
  dateField?: string;
}
```

### Entity Example

```typescript
import { Entity, Column, PrimaryGeneratedColumn } from 'typeorm';
import { DateTransformer } from '../../utils/date-transformer';

@Entity('examples')
export class Example {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ length: 255 })
  name: string;

  @Column({
    type: 'date',
    nullable: true,
    transformer: DateTransformer,
  })
  dateField?: Date;

  @CreateDateColumn({
    name: 'created_at',
    type: 'datetime',
  })
  createdAt: Date;

  @UpdateDateColumn({
    name: 'updated_at',
    type: 'datetime',
  })
  updatedAt: Date;
}
```

---

## ğŸš€ PERFORMANCE TIPS

1. **Database Queries**: Sá»­ dá»¥ng `select` Ä‘á»ƒ chá»‰ láº¥y fields cáº§n thiáº¿t
2. **Pagination**: LuÃ´n implement pagination cho list APIs
3. **Caching**: Cache data khÃ´ng thay Ä‘á»•i thÆ°á»ng xuyÃªn
4. **Async/Await**: Sá»­ dá»¥ng async/await thay vÃ¬ Promises
5. **Validation**: Validate input sá»›m Ä‘á»ƒ trÃ¡nh xá»­ lÃ½ khÃ´ng cáº§n thiáº¿t

---

## ğŸ”’ SECURITY CHECKLIST

- [ ] **JWT Authentication**: Protect sensitive endpoints
- [ ] **Permission-based Authorization**: Check user permissions
- [ ] **Input Validation**: Validate all input data
- [ ] **SQL Injection**: Sá»­ dá»¥ng TypeORM Ä‘á»ƒ trÃ¡nh SQL injection
- [ ] **HTTPS**: LuÃ´n sá»­ dá»¥ng HTTPS trong production

Nhá»¯ng quy táº¯c nÃ y Ä‘áº£m báº£o API cÃ³ tÃ­nh nháº¥t quÃ¡n, báº£o máº­t vÃ  dá»… maintain!
